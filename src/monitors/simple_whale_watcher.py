"""
Simple Whale Watcher - MVP Core Logic
======================================

This is the CORE MONITORING ENGINE for the Whale Tracker project.

Current Implementation: MVP (Phase 1)
--------------------------------------
- Direct transaction monitoring (whale -> exchange)
- Basic one-hop detection (whale -> unknown -> exchange)
- Statistical anomaly detection
- Alert cooldown management

FUTURE EVOLUTION ROADMAP
========================

This document describes how to evolve this simple watcher into a sophisticated
whale tracking system that provides REAL COMPETITIVE ADVANTAGE.

========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
PHASE 1: MVP - Simple Monitoring (CURRENT)
========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================

What we do NOW:
1. Check whale balance periodically (every 15 min)
2. If balance decreased significantly -> get recent transactions
3. Check if transaction went to known exchange -> ALERT
4. Simple one-hop: check if intermediate address sent to exchange within 2 hours

Limitations:
- No price impact calculation
- No persistent database
- Simple time-based one-hop (naive)
- No pattern learning
- No cross-chain tracking

========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
PHASE 2: Advanced One-Hop Tracking - THE REAL EDGE
========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================

WHY ONE-HOP IS OUR EDGE:
------------------------
Most whale trackers (including Arkham) show:
  "Vitalik sent 1000 ETH to 0xabc123..."

They DON'T automatically show:
  "...and 0xabc123 sent 1000 ETH to Binance 15 minutes later"

This is HUGE because ~80% of sophisticated whales use intermediate addresses.

NAIVE ONE-HOP (Current MVP):
---------------------------
```python
# Simple approach (what we do now):
whale -> intermediate (timestamp T1)
if intermediate -> exchange within 2 hours of T1:
    ALERT: "Possible one-hop to exchange"
```

Problems with naive approach:
1. Time window too arbitrary (why 2 hours?)
2. No confidence scoring
3. High false positives (intermediate could be legitimate)
4. Misses sophisticated patterns

ADVANCED ONE-HOP (Phase 2 Implementation):
------------------------------------------

### Signal #1: TIME CORRELATION (Optimal Window)
```python
# NOT just "within 2 hours", but ADAPTIVE window based on:

time_since_whale_tx = intermediate_tx_time - whale_tx_time

# Suspicious patterns:
if 1 minute < time_since_whale_tx < 60 minutes:
    confidence += 30  # Fast enough to be same entity

if time_since_whale_tx < 1 minute:
    confidence -= 20  # TOO fast (likely exchange internal transfer)

if time_since_whale_tx > 6 hours:
    confidence -= 40  # Too slow (likely different entity)

# BEST SIGNAL: 5-30 minutes delay
# This is "human reaction time" - whale sends, waits a bit, then moves again
if 5 minutes < time_since_whale_tx < 30 minutes:
    confidence += 50  # GOLDEN WINDOW
```

### Signal #2: GAS PRICE CORRELATION
```python
# CRITICAL INSIGHT: Same entity often uses same gas settings

whale_tx_gas_price = whale_tx['gasPrice']
intermediate_tx_gas_price = intermediate_tx['gasPrice']

gas_price_diff_pct = abs(whale_tx_gas_price - intermediate_tx_gas_price) / whale_tx_gas_price

if gas_price_diff_pct < 0.05:  # Within 5%
    confidence += 40  # VERY strong signal - same gas price = likely same entity

if gas_price_diff_pct < 0.15:  # Within 15%
    confidence += 20  # Still good signal

# ADVANCED: Check if both used same gas strategy
# (e.g., both used "fast" priority, both used round numbers like 50 gwei)
```

### Signal #3: NONCE TRACKING (Advanced)
```python
# Track nonce sequences for intermediate address

intermediate_nonce_at_whale_tx = get_nonce(intermediate, block=whale_tx.block)
intermediate_nonce_at_exchange_tx = intermediate_tx['nonce']

nonce_gap = intermediate_nonce_at_exchange_tx - intermediate_nonce_at_whale_tx

if nonce_gap == 1:
    confidence += 60  # STRONGEST SIGNAL
    # This means: intermediate received from whale, IMMEDIATELY sent to exchange
    # No other transactions in between = very likely one-hop

if nonce_gap <= 3:
    confidence += 30  # Still strong - only a few txs in between

if nonce_gap > 10:
    confidence -= 30  # Many transactions in between = likely different purpose
```

### Signal #4: AMOUNT CORRELATION
```python
# Check if amounts match (accounting for gas fees)

whale_sent_amount = whale_tx['value']
intermediate_received = whale_sent_amount  # What intermediate got
intermediate_sent = intermediate_tx['value']

# Calculate expected amount (after gas fees)
gas_used = intermediate_tx['gasUsed'] * intermediate_tx['gasPrice']
expected_sent = intermediate_received - gas_used

amount_match_pct = intermediate_sent / expected_sent

if 0.98 < amount_match_pct < 1.02:
    confidence += 50  # Almost exact match = very likely one-hop

if 0.95 < amount_match_pct < 1.05:
    confidence += 30

# SPLIT DETECTION: If intermediate splits into multiple exchanges
# e.g., whale sends 1000 ETH -> intermediate sends 600 to Binance, 400 to Coinbase
total_sent_to_exchanges = sum(all_intermediate_txs_to_exchanges)
if 0.95 < (total_sent_to_exchanges / whale_sent_amount) < 1.05:
    confidence += 40  # Detected split dump!
```

### Signal #5: INTERMEDIATE ADDRESS HISTORY
```python
# CRITICAL: Check if intermediate address is "fresh" or "reused"

intermediate_tx_count = get_transaction_count(intermediate)
intermediate_balance = get_balance(intermediate)
intermediate_age_days = get_address_age(intermediate)

# Pattern 1: FRESH ADDRESS (Strong one-hop signal)
if intermediate_tx_count < 5 and intermediate_age_days < 7:
    confidence += 50  # New address = likely created for this one-hop

# Pattern 2: EMPTY AFTER SEND (Strong signal)
if intermediate_balance < 0.01 ETH:  # Almost empty after sending
    confidence += 40  # Whale emptied it after use

# Pattern 3: REPEATED PATTERN (Machine learning opportunity)
# Check if whale has used this intermediate before
if intermediate in whale_previous_hops:
    confidence += 60  # VERY strong - whale reuses same hop address

# Pattern 4: ACTIVE INTERMEDIATE (Negative signal)
if intermediate_tx_count > 100:
    confidence -= 40  # Too active = probably real user, not hop address
```

### Signal #6: NETWORK CLUSTERING (Advanced Graph Analysis)
```python
# Build graph of related addresses

# Check if multiple whales use same intermediate
shared_intermediate_count = count_whales_using_address(intermediate)

if shared_intermediate_count > 5:
    confidence -= 50  # Shared by many = likely legitimate service (mixer, bridge)

if shared_intermediate_count == 1:
    confidence += 30  # Only this whale uses it = likely personal hop address

# Check if whale has MULTIPLE intermediates with similar patterns
whale_hop_cluster = find_similar_addresses(whale, pattern='one-hop')

if len(whale_hop_cluster) > 3:
    confidence += 40  # Whale has pattern of using hops = this is likely one too
```

### Signal #7: MULTI-HOP DETECTION (2-hop, 3-hop)
```python
# Don't stop at one-hop - check for chains:
# whale -> addr1 -> addr2 -> exchange
# whale -> addr1 -> addr2 -> addr3 -> exchange

max_hops = 4  # Check up to 4 hops
for hop_count in range(1, max_hops + 1):
    chain = trace_transaction_chain(whale, max_depth=hop_count)

    if chain.ends_at_exchange:
        # Score based on chain characteristics
        chain_confidence = calculate_chain_confidence(chain)

        # Longer chains = lower confidence (more room for false positives)
        chain_confidence *= (0.8 ** (hop_count - 1))

        if chain_confidence > 60:
            ALERT: f"{hop_count}-hop dump detected"
```

### Signal #8: DEX INTERACTION DETECTION
```python
# Sophisticated whales often:
# 1. Send ETH to intermediate
# 2. Intermediate swaps ETH -> USDT on Uniswap
# 3. Intermediate sends USDT to exchange

# This avoids direct ETH -> exchange (less obvious)

intermediate_txs = get_all_transactions(intermediate, since=whale_tx.timestamp)

for tx in intermediate_txs:
    if is_dex_interaction(tx):  # Uniswap, Curve, etc.
        # Check if they swapped to stablecoin
        if tx.output_token in ['USDT', 'USDC', 'DAI']:
            confidence += 40  # Swap to stable = preparing to sell

            # Then check if stablecoin went to exchange
            stablecoin_txs = get_token_transfers(intermediate, token=tx.output_token)
            if any(tx.to in EXCHANGES for tx in stablecoin_txs):
                confidence += 50  # BINGO: ETH -> stable -> exchange via DEX
```

### Signal #9: CROSS-CHAIN BRIDGE DETECTION
```python
# Whales might bridge to another chain before selling
# whale -> intermediate -> bridge -> exchange on other chain

if intermediate_tx.to in BRIDGE_ADDRESSES:
    # Track on destination chain
    dest_chain = get_bridge_destination(intermediate_tx)
    dest_address = get_bridge_recipient(intermediate_tx)

    # Check destination chain for exchange deposits
    dest_txs = get_transactions(dest_address, chain=dest_chain)

    if any(tx.to in EXCHANGES for tx in dest_txs):
        confidence += 50  # Cross-chain hop detected!
```

### Signal #10: PRIVACY PROTOCOL DETECTION (Tornado Cash, etc.)
```python
# Some whales use mixers/privacy protocols as intermediate step

if intermediate in KNOWN_MIXER_ADDRESSES:
    # This is tricky - might be legitimate privacy, or dump attempt

    # Check withdrawal pattern from mixer
    mixer_withdrawals = get_mixer_withdrawals(after=whale_deposit)

    # Look for withdrawals with matching amounts (accounting for mixer denominations)
    # and timing patterns
    matching_withdrawals = find_matching_withdrawals(whale_sent_amount, mixer_withdrawals)

    if matching_withdrawals:
        for withdrawal in matching_withdrawals:
            if withdrawal.destination in EXCHANGES:
                confidence += 30  # Detected through mixer (lower confidence due to uncertainty)
```

### CONFIDENCE SCORING SYSTEM
```python
# Combine all signals into final confidence score

final_confidence = sum(all_signal_confidences)

# Classification:
if final_confidence > 80:
    return "HIGH CONFIDENCE ONE-HOP DUMP"
elif final_confidence > 60:
    return "PROBABLE ONE-HOP"
elif final_confidence > 40:
    return "POSSIBLE ONE-HOP (Monitor closely)"
else:
    return "UNLIKELY ONE-HOP"

# Include breakdown in alert:
# Example alert format:
# [ALERT] ONE-HOP DUMP DETECTED (Confidence: {final_confidence}%)
#
# Whale: {whale_address}
# -> {whale_amount} ETH ({time_1})
# Intermediate: {intermediate_address}
# -> {intermediate_amount} ETH ({time_2})  [Delta {time_delta} minutes]
# Exchange: {exchange_name}
#
# Signal Breakdown:
# [+] Time correlation: +{time_signal}
# [+] Gas price match: +{gas_signal}
# [+] Nonce sequence: +{nonce_signal}
# [+] Amount match: +{amount_signal}
# [+] Fresh address: +{freshness_signal}
#
# Recommendation: {recommendation}
```

========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
PHASE 2: Price Impact Tracking
========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================

Add to current monitoring:

```python
# When dump detected, calculate potential price impact

dump_amount_usd = transaction_amount * current_price
daily_volume = get_24h_volume('ETH')

impact_ratio = dump_amount_usd / daily_volume

if impact_ratio > 0.01:  # >1% of daily volume
    potential_price_impact = estimate_price_impact(dump_amount_usd, liquidity_depth)

    # ALERT: f"[WARNING] Large dump may cause {potential_price_impact}% price drop"

# Store in database for historical analysis
db.store_dump_event({
    'whale': whale_address,
    'amount_usd': dump_amount_usd,
    'timestamp': timestamp,
    'price_before': price_before,
    'price_after': price_after,  # Track 1h, 6h, 24h after
    'actual_impact': actual_price_change,
    'volume_ratio': impact_ratio
})
```

========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
PHASE 3: Pattern Learning & Whale Profiling
========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================

Build historical patterns for each whale:

```python
class WhaleProfile:
    def __init__(self, whale_address):
        self.address = whale_address
        self.dump_history = []  # All historical dumps
        self.preferred_hops = []  # Addresses they use as intermediates
        self.preferred_exchanges = []  # Which exchanges they use
        self.timing_patterns = {}  # When they usually dump (day/night, weekday/weekend)

    def analyze_behavior(self):
        # Learn whale's patterns

        # Pattern 1: Timing
        dump_hours = [d.hour for d in self.dump_history]
        preferred_hour = most_common(dump_hours)

        if current_hour == preferred_hour:
            confidence += 20  # Whale dumps at usual time

        # Pattern 2: Market conditions
        dump_conditions = [get_market_state(d.timestamp) for d in self.dump_history]

        if all(c == 'bull_market' for c in dump_conditions):
            if current_market == 'bull_market':
                confidence += 30  # Whale only dumps in bull markets

        # Pattern 3: Transaction frequency before dump
        # Some whales accumulate, then dump
        # Others dump immediately after receiving

        avg_hold_time = calculate_average_hold_time(self.dump_history)
        current_hold_time = time_since_last_receive()

        if current_hold_time >= avg_hold_time * 0.9:
            confidence += 40  # Holding longer than usual = dump incoming

    def predict_next_dump(self):
        # Use machine learning on historical patterns

        features = [
            'current_balance',
            'time_since_last_dump',
            'current_price',
            'price_change_24h',
            'volume_24h',
            'day_of_week',
            'hour_of_day'
        ]

        probability = ml_model.predict(features)

        return probability  # 0-100% chance of dump in next 24h
```

========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
PHASE 4: AI-Powered Analysis
========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================

Use AI to analyze complex patterns:

```python
# Feed transaction graph to LLM for analysis

prompt = f'''
Analyze this whale transaction pattern:

Whale: {whale_address}
Recent transactions:
{format_transactions(recent_txs)}

Intermediate addresses used:
{format_addresses(intermediate_addresses)}

Market context:
- Current price: ${current_price}
- 24h change: {price_change_24h}%
- Fear & Greed Index: {fear_greed_index}

Historical behavior:
{whale_profile.summary()}

Question: Is this whale preparing to dump? What's the confidence level?
Provide reasoning based on on-chain behavior and market context.
'''

ai_analysis = claude.analyze(prompt)

# AI can spot patterns humans miss:
# - Coordinated dumps with other whales
# - Response to news events
# - Correlation with derivatives markets
# - Social media sentiment before dump
```

========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
DATABASE SCHEMA (Phase 2+)
========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================

```sql
-- Whale tracking
CREATE TABLE whales (
    address TEXT PRIMARY KEY,
    first_seen TIMESTAMP,
    last_checked TIMESTAMP,
    total_dumps INTEGER,
    total_volume_usd REAL
);

-- Transaction history
CREATE TABLE transactions (
    tx_hash TEXT PRIMARY KEY,
    whale_address TEXT,
    from_address TEXT,
    to_address TEXT,
    amount_eth REAL,
    amount_usd REAL,
    timestamp TIMESTAMP,
    block_number INTEGER,
    gas_price REAL,
    is_dump BOOLEAN,
    confidence_score REAL,
    FOREIGN KEY (whale_address) REFERENCES whales(address)
);

-- One-hop tracking
CREATE TABLE one_hop_chains (
    id INTEGER PRIMARY KEY,
    whale_address TEXT,
    hop_count INTEGER,
    confidence_score REAL,
    total_amount_usd REAL,
    start_timestamp TIMESTAMP,
    end_timestamp TIMESTAMP,
    final_exchange TEXT,
    FOREIGN KEY (whale_address) REFERENCES whales(address)
);

CREATE TABLE hop_chain_steps (
    chain_id INTEGER,
    step_number INTEGER,
    from_address TEXT,
    to_address TEXT,
    tx_hash TEXT,
    amount_eth REAL,
    timestamp TIMESTAMP,
    PRIMARY KEY (chain_id, step_number),
    FOREIGN KEY (chain_id) REFERENCES one_hop_chains(id)
);

-- Price impact tracking
CREATE TABLE price_snapshots (
    id INTEGER PRIMARY KEY,
    transaction_id TEXT,
    snapshot_time TEXT,  -- 'before', '1h_after', '6h_after', '24h_after'
    price_usd REAL,
    volume_24h REAL,
    FOREIGN KEY (transaction_id) REFERENCES transactions(tx_hash)
);
```

========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
PERFORMANCE OPTIMIZATIONS
========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================

Current: Check all whales sequentially every 15 min
Problem: Slow for 100+ whales

Phase 2 Optimizations:

1. Event-based monitoring instead of polling:
   ```python
   # Subscribe to blockchain events for whale addresses
   web3.eth.filter({
       'address': whale_addresses,
       'topics': [TRANSFER_EVENT_SIGNATURE]
   })

   # React in real-time instead of periodic checks
   ```

2. Parallel processing:
   ```python
   import asyncio

   async def check_whale(whale_address):
       # Check one whale
       pass

   async def check_all_whales():
       tasks = [check_whale(addr) for addr in whale_addresses]
       results = await asyncio.gather(*tasks)
   ```

3. Caching & rate limit management:
   ```python
   @cache(ttl=60)  # Cache for 1 minute
   def get_balance(address):
       return web3.eth.get_balance(address)
   ```

4. Smart polling (adaptive intervals):
   ```python
   # Check active whales more frequently
   if whale.recent_activity:
       check_interval = 5 minutes
   else:
       check_interval = 30 minutes
   ```

========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================

Author: Whale Tracker Project
Version: 1.0.0 (MVP)
Last Updated: 2024
"""

import asyncio
import logging
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Tuple
from web3 import Web3

from ..core.web3_manager import Web3Manager
from ..core.whale_config import WhaleConfig, classify_address
from ..analyzers.whale_analyzer import WhaleAnalyzer
from ..analyzers.nonce_tracker import NonceTracker
from ..analyzers.gas_correlator import GasCorrelator
from ..analyzers.address_profiler import AddressProfiler
from ..notifications.telegram_notifier import TelegramNotifier
from config.settings import Settings


logger = logging.getLogger(__name__)


class SimpleWhaleWatcher:
    """
    MVP Whale Monitoring Engine.

    Current capabilities (Phase 1):
    - Periodic balance checking
    - Direct dump detection (whale -> exchange)
    - Simple one-hop detection (whale -> unknown -> exchange within time window)
    - Statistical anomaly alerts
    - Alert cooldown management

    See file header for detailed evolution roadmap to advanced system.
    """

    def __init__(
        self,
        web3_manager: Optional[Web3Manager] = None,
        whale_config: Optional[WhaleConfig] = None,
        analyzer: Optional[WhaleAnalyzer] = None,
        notifier: Optional[TelegramNotifier] = None,
        settings: Optional[Settings] = None,
        # Advanced one-hop analyzers (optional)
        nonce_tracker: Optional[NonceTracker] = None,
        gas_correlator: Optional[GasCorrelator] = None,
        address_profiler: Optional[AddressProfiler] = None
    ):
        """
        Initialize Simple Whale Watcher.

        Args:
            web3_manager: Web3 connection manager (optional, will create if None)
            whale_config: Whale address configuration (optional)
            analyzer: Statistical analyzer (optional)
            notifier: Telegram notification manager (optional)
            settings: Configuration settings (optional)
            nonce_tracker: Nonce sequence tracker for advanced one-hop (optional)
            gas_correlator: Gas price correlator for advanced one-hop (optional)
            address_profiler: Address profiler for advanced one-hop (optional)
        """
        self.web3_manager = web3_manager or Web3Manager()
        self.whale_config = whale_config or WhaleConfig()
        self.analyzer = analyzer or WhaleAnalyzer()
        self.notifier = notifier or TelegramNotifier()
        self.settings = settings or Settings()

        # Advanced one-hop analyzers (optional - if None, uses simple one-hop)
        self.nonce_tracker = nonce_tracker
        self.gas_correlator = gas_correlator
        self.address_profiler = address_profiler

        # Track last known balances
        self.last_balances: Dict[str, float] = {}

        # Track last alert times (for cooldown)
        self.last_alerts: Dict[str, datetime] = {}

        # Determine if advanced one-hop is available
        self.has_advanced_onehop = all([
            self.nonce_tracker is not None,
            self.gas_correlator is not None,
            self.address_profiler is not None
        ])

        if self.has_advanced_onehop:
            logger.info("SimpleWhaleWatcher initialized with ADVANCED one-hop detection")
        else:
            logger.info("SimpleWhaleWatcher initialized with simple one-hop detection")

    async def check_whale(self, whale_address: str) -> Dict:
        """
        Check a single whale for suspicious activity.

        Current implementation (MVP):
        1. Get current balance
        2. Compare with last known balance
        3. If decreased significantly, get recent transactions
        4. Check if transactions went to exchanges
        5. Perform simple one-hop check

        Args:
            whale_address: Ethereum address to monitor

        Returns:
            Dict with check results and any alerts generated
        """
        try:
            logger.info(f"Checking whale: {whale_address}")

            # Get current balance
            current_balance = await self.web3_manager.get_balance(whale_address)

            # First time seeing this whale
            if whale_address not in self.last_balances:
                self.last_balances[whale_address] = current_balance
                return {'status': 'initialized', 'balance': current_balance}

            # Calculate balance change
            previous_balance = self.last_balances[whale_address]
            balance_change = previous_balance - current_balance

            # Update last known balance
            self.last_balances[whale_address] = current_balance

            # Check if balance decreased significantly
            min_amount = self.settings.MIN_AMOUNT_USD / 3500  # Rough USD to ETH conversion

            if balance_change < min_amount:
                logger.debug(f"Balance change below threshold: {balance_change} ETH")
                return {'status': 'no_significant_change', 'balance_change': balance_change}

            logger.warning(f"Significant balance decrease detected: {balance_change} ETH")

            # Get recent transactions
            recent_txs = await self._get_recent_transactions(whale_address, limit=10)

            # Analyze transactions
            alerts = []
            for tx in recent_txs:
                # Check direct dumps (whale -> exchange)
                direct_dump = await self._check_direct_dump(whale_address, tx)
                if direct_dump:
                    alerts.append(direct_dump)

                # Check one-hop (whale -> unknown -> exchange)
                # Use advanced one-hop if analyzers available, otherwise simple
                if self.has_advanced_onehop:
                    one_hop = await self._check_advanced_one_hop(whale_address, tx)
                else:
                    one_hop = await self._check_simple_one_hop(whale_address, tx)
                if one_hop:
                    alerts.append(one_hop)

            return {
                'status': 'alerts_generated' if alerts else 'checked',
                'balance_change': balance_change,
                'alerts': alerts
            }

        except Exception as e:
            logger.error(f"Error checking whale {whale_address}: {str(e)}")
            return {'status': 'error', 'error': str(e)}

    async def _get_recent_transactions(
        self,
        address: str,
        limit: int = 10
    ) -> List[Dict]:
        """
        Get recent transactions for an address.

        MVP implementation: Use Web3Manager stub.
        Phase 2: Use get_recent_transactions() from web3_manager.
        Phase 3: Use database for historical lookup.

        Args:
            address: Ethereum address
            limit: Maximum number of transactions to return

        Returns:
            List of transaction dictionaries
        """
        # TODO PHASE 2: Implement actual transaction fetching
        # return await self.web3_manager.get_recent_transactions(address, limit)

        # MVP: Return empty for now (stub)
        logger.warning("get_recent_transactions not implemented yet (Phase 2)")
        return []

    async def _check_direct_dump(
        self,
        whale_address: str,
        tx: Dict
    ) -> Optional[Dict]:
        """
        Check if transaction is direct dump to exchange.

        Args:
            whale_address: The whale's address
            tx: Transaction data

        Returns:
            Alert dict if dump detected, None otherwise
        """
        destination = tx.get('to', '').lower()

        # Check if destination is known exchange
        if not self.whale_config.is_exchange(destination):
            return None

        amount_eth = float(tx.get('value', 0)) / 1e18
        amount_usd = amount_eth * 3500  # TODO PHASE 2: Get real price

        # Check if amount exceeds threshold
        if amount_usd < self.settings.MIN_AMOUNT_USD:
            return None

        # Check anomaly
        anomaly = self.analyzer.detect_anomaly(whale_address, amount_usd)

        # Check alert cooldown
        if not self._can_send_alert(whale_address):
            logger.info(f"Skipping alert due to cooldown: {whale_address}")
            return None

        # Generate alert
        exchange_info = self.whale_config.get_metadata(destination)

        alert = {
            'type': 'direct_dump',
            'whale_address': whale_address,
            'exchange': exchange_info.name if exchange_info else destination,
            'amount_eth': amount_eth,
            'amount_usd': amount_usd,
            'tx_hash': tx.get('hash', ''),
            'is_anomaly': anomaly.is_anomaly,
            'anomaly_confidence': anomaly.confidence,
            'timestamp': datetime.now()
        }

        # Send notification
        await self.notifier.send_whale_direct_transfer_alert(
            whale_address=whale_address,
            tx_data={
                'value_usd': amount_usd,
                'hash': tx.get('hash', '')
            },
            destination_info={
                'name': exchange_info.name if exchange_info else 'Unknown Exchange'
            }
        )

        # Update last alert time
        self.last_alerts[whale_address] = datetime.now()

        # Track transaction in analyzer
        self.analyzer.add_transaction(whale_address, amount_usd)

        return alert

    async def _check_simple_one_hop(
        self,
        whale_address: str,
        whale_tx: Dict
    ) -> Optional[Dict]:
        """
        Simple one-hop detection (MVP version).

        Current logic:
        1. Whale sends to unknown address (not exchange, not DeFi)
        2. Check if unknown address sent to exchange within time window

        TODO PHASE 2: Replace with sophisticated version from file header:
        - Gas price correlation
        - Nonce tracking
        - Amount matching
        - Address clustering
        - Multi-hop detection
        - DEX interaction detection
        - Cross-chain bridges
        - Confidence scoring

        Args:
            whale_address: The whale's address
            whale_tx: Transaction from whale

        Returns:
            Alert dict if one-hop detected, None otherwise
        """
        intermediate = whale_tx.get('to', '').lower()

        # Skip if destination is known (exchange, DeFi, etc.)
        destination_class = classify_address(intermediate)
        if destination_class['is_known']:
            return None

        logger.info(f"Checking one-hop for intermediate: {intermediate}")

        # Get transactions from intermediate address
        # TODO PHASE 2: Implement this properly
        intermediate_txs = await self._get_recent_transactions(intermediate, limit=20)

        whale_tx_time = whale_tx.get('timestamp', datetime.now())
        time_window_hours = self.settings.whale_monitoring.intervals.onehop_check_hours

        # Check each intermediate transaction
        for int_tx in intermediate_txs:
            int_destination = int_tx.get('to', '').lower()
            int_tx_time = int_tx.get('timestamp', datetime.now())

            # Check if sent to exchange
            if not self.whale_config.is_exchange(int_destination):
                continue

            # Check time window (simple version - TODO PHASE 2: use smart window)
            time_diff = (int_tx_time - whale_tx_time).total_seconds() / 3600

            if 0 < time_diff < time_window_hours:
                # One-hop detected!
                logger.warning(f"One-hop detected: {whale_address} -> {intermediate} -> {int_destination}")

                amount_eth = float(whale_tx.get('value', 0)) / 1e18
                amount_usd = amount_eth * 3500  # TODO PHASE 2: Real price

                if amount_usd < self.settings.MIN_AMOUNT_USD:
                    continue

                # Check cooldown
                if not self._can_send_alert(whale_address):
                    continue

                exchange_info = self.whale_config.get_metadata(int_destination)

                alert = {
                    'type': 'one_hop_dump',
                    'whale_address': whale_address,
                    'intermediate_address': intermediate,
                    'exchange': exchange_info.name if exchange_info else int_destination,
                    'amount_eth': amount_eth,
                    'amount_usd': amount_usd,
                    'whale_tx_hash': whale_tx.get('hash', ''),
                    'exchange_tx_hash': int_tx.get('hash', ''),
                    'time_delay_minutes': time_diff * 60,
                    'timestamp': datetime.now()
                }

                # Send notification
                await self.notifier.send_whale_onehop_alert(
                    whale_address=whale_address,
                    whale_tx={
                        'value_usd': amount_usd,
                        'hash': whale_tx.get('hash', '')
                    },
                    intermediate_address=intermediate,
                    onehop_result={
                        'exchange_name': exchange_info.name if exchange_info else 'Unknown',
                        'time_delay_minutes': time_diff * 60
                    }
                )

                self.last_alerts[whale_address] = datetime.now()
                self.analyzer.add_transaction(whale_address, amount_usd)

                return alert

        return None

    async def _check_advanced_one_hop(
        self,
        whale_address: str,
        whale_tx: Dict
    ) -> Optional[Dict]:
        """
        ADVANCED one-hop detection using multiple signals (Phase 2).

        Uses three sophisticated analyzers:
        1. NonceTracker - Sequential nonce detection (STRONGEST, +95 confidence)
        2. GasCorrelator - Gas price matching (+80-95 confidence)
        3. AddressProfiler - Intermediate address profiling (+70-95 confidence)

        Composite confidence scoring combines all signals for highly accurate detection.

        Args:
            whale_address: The whale's address
            whale_tx: Transaction from whale

        Returns:
            Alert dict with confidence score if one-hop detected, None otherwise
        """
        intermediate = whale_tx.get('to', '').lower()

        # Skip if destination is known (exchange, DeFi, etc.)
        destination_class = classify_address(intermediate)
        if destination_class['is_known']:
            return None

        logger.info(f"Advanced one-hop check for intermediate: {intermediate}")

        # Get transactions from intermediate address
        intermediate_txs = await self._get_recent_transactions(intermediate, limit=20)

        whale_tx_time = whale_tx.get('timestamp', datetime.now())
        whale_tx_block = whale_tx.get('blockNumber', 0)
        time_window_hours = self.settings.whale_monitoring.intervals.onehop_check_hours

        # Check each intermediate transaction
        for int_tx in intermediate_txs:
            int_destination = int_tx.get('to', '').lower()
            int_tx_time = int_tx.get('timestamp', datetime.now())

            # Check if sent to exchange
            if not self.whale_config.is_exchange(int_destination):
                continue

            # Check time window
            time_diff = (int_tx_time - whale_tx_time).total_seconds() / 3600

            if not (0 < time_diff < time_window_hours):
                continue

            # ADVANCED SIGNAL ANALYSIS
            signals = {}
            total_confidence = 0

            # Signal #1: Time Correlation (basic, already checked above)
            time_diff_minutes = time_diff * 60
            if 5 < time_diff_minutes < 30:
                # Golden window: human reaction time
                time_confidence = 50
            elif time_diff_minutes < 60:
                time_confidence = 30
            else:
                time_confidence = 10

            signals['time'] = {
                'confidence': time_confidence,
                'details': f'{time_diff_minutes:.1f} minutes delay'
            }
            total_confidence += time_confidence

            # Signal #2: Gas Price Correlation
            if self.gas_correlator:
                gas_result = self.gas_correlator.check_gas_correlation(whale_tx, int_tx)
                signals['gas'] = {
                    'match': gas_result.match,
                    'confidence': gas_result.confidence,
                    'type': gas_result.correlation_type,
                    'details': gas_result.details
                }
                total_confidence += gas_result.confidence
                logger.info(f"Gas correlation: {gas_result.correlation_type} ({gas_result.confidence}%)")

            # Signal #3: Nonce Tracking (STRONGEST)
            if self.nonce_tracker:
                nonce_result = await self.nonce_tracker.check_nonce_sequence(whale_tx, int_tx)
                signals['nonce'] = {
                    'match': nonce_result.match,
                    'confidence': nonce_result.confidence,
                    'gap': nonce_result.nonce_gap,
                    'strength': nonce_result.signal_strength,
                    'details': nonce_result.details
                }
                total_confidence += nonce_result.confidence
                if nonce_result.match:
                    logger.warning(f"Nonce correlation: {nonce_result.signal_strength} (gap={nonce_result.nonce_gap}, {nonce_result.confidence}%)")

            # Signal #4: Address Profiling
            if self.address_profiler:
                profile = await self.address_profiler.profile_address(
                    intermediate,
                    whale_tx_block,
                    whale_tx_time
                )
                signals['profile'] = {
                    'type': profile.profile_type,
                    'confidence': profile.overall_confidence,
                    'is_fresh': profile.is_fresh,
                    'is_burner': profile.is_single_use,
                    'is_reused': profile.is_reused,
                    'details': profile.details
                }
                total_confidence += profile.overall_confidence
                logger.info(f"Address profile: {profile.profile_type} ({profile.overall_confidence}%)")

            # Normalize confidence (average of signals)
            num_signals = len([s for s in signals.values() if s.get('confidence', 0) > 0])
            if num_signals > 0:
                average_confidence = int(total_confidence / max(num_signals, 1))
            else:
                average_confidence = 0

            # High confidence threshold for alerting
            MIN_CONFIDENCE = 60  #   60% 

            if average_confidence < MIN_CONFIDENCE:
                logger.info(f"Confidence too low: {average_confidence}% < {MIN_CONFIDENCE}%")
                continue

            # Calculate amounts
            amount_eth = float(whale_tx.get('value', 0)) / 1e18
            amount_usd = amount_eth * 3500  # TODO PHASE 2: Real price

            if amount_usd < self.settings.MIN_AMOUNT_USD:
                continue

            # Check cooldown
            if not self._can_send_alert(whale_address):
                continue

            exchange_info = self.whale_config.get_metadata(int_destination)

            # Create alert with detailed signal analysis
            alert = {
                'type': 'advanced_one_hop_dump',
                'whale_address': whale_address,
                'intermediate_address': intermediate,
                'exchange': exchange_info.name if exchange_info else int_destination,
                'amount_eth': amount_eth,
                'amount_usd': amount_usd,
                'whale_tx_hash': whale_tx.get('hash', ''),
                'exchange_tx_hash': int_tx.get('hash', ''),
                'time_delay_minutes': time_diff_minutes,
                'confidence': average_confidence,
                'signals': signals,
                'timestamp': datetime.now()
            }

            # Send enhanced notification with confidence score
            await self.notifier.send_whale_onehop_alert(
                whale_address=whale_address,
                whale_tx={
                    'value_usd': amount_usd,
                    'hash': whale_tx.get('hash', '')
                },
                intermediate_address=intermediate,
                onehop_result={
                    'exchange_name': exchange_info.name if exchange_info else 'Unknown',
                    'time_delay_minutes': time_diff_minutes,
                    'confidence': average_confidence,
                    'signals': {
                        k: f"{v.get('type', '')} ({v.get('confidence', 0)}%)"
                        for k, v in signals.items()
                        if v.get('confidence', 0) > 0
                    }
                }
            )

            self.last_alerts[whale_address] = datetime.now()
            self.analyzer.add_transaction(whale_address, amount_usd)

            logger.warning(
                f"ADVANCED ONE-HOP DETECTED! "
                f"Confidence: {average_confidence}% "
                f"Signals: {num_signals} "
                f"Amount: ${amount_usd:,.0f}"
            )

            return alert

        return None

    def _can_send_alert(self, whale_address: str) -> bool:
        """
        Check if we can send alert (cooldown period).

        Args:
            whale_address: Whale address to check

        Returns:
            True if cooldown period has passed, False otherwise
        """
        if whale_address not in self.last_alerts:
            return True

        last_alert = self.last_alerts[whale_address]
        cooldown_minutes = self.settings.whale_monitoring.intervals.alert_cooldown_minutes
        time_since_last = (datetime.now() - last_alert).total_seconds() / 60

        return time_since_last >= cooldown_minutes

    async def monitor_all_whales(self) -> Dict:
        """
        Check all configured whale addresses.

        Returns:
            Summary of monitoring results
        """
        whale_addresses = self.settings.WHALE_ADDRESSES

        if not whale_addresses:
            logger.warning("No whale addresses configured")
            return {'status': 'no_whales_configured'}

        logger.info(f"Monitoring {len(whale_addresses)} whales")

        results = []
        for whale_addr in whale_addresses:
            result = await self.check_whale(whale_addr)
            results.append(result)

        # Summary
        total_alerts = sum(len(r.get('alerts', [])) for r in results)

        return {
            'status': 'completed',
            'whales_checked': len(whale_addresses),
            'total_alerts': total_alerts,
            'results': results,
            'timestamp': datetime.now()
        }
