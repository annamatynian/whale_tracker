# Alembic Database Migrations

This directory contains database migrations for the Whale Tracker project.

## Setup

Database migrations are managed using Alembic, which provides version control for database schemas.

## Configuration

- **alembic.ini**: Alembic configuration file
- **env.py**: Migration environment setup
- **script.py.mako**: Template for new migrations
- **versions/**: Migration scripts directory

## Usage

### Create a New Migration

```bash
# Auto-generate migration from model changes
alembic revision --autogenerate -m "description of changes"

# Create empty migration for manual changes
alembic revision -m "description of changes"
```

### Apply Migrations

```bash
# Upgrade to latest version
alembic upgrade head

# Upgrade one version
alembic upgrade +1

# Upgrade to specific revision
alembic upgrade <revision_id>
```

### Rollback Migrations

```bash
# Downgrade one version
alembic downgrade -1

# Downgrade to specific revision
alembic downgrade <revision_id>

# Downgrade all (back to empty database)
alembic downgrade base
```

### View Migration History

```bash
# Show current version
alembic current

# Show migration history
alembic history

# Show pending migrations
alembic heads
```

## Migration Structure

Each migration file contains:

- `revision`: Unique identifier for this migration
- `down_revision`: Previous migration in the chain
- `upgrade()`: Function to apply migration
- `downgrade()`: Function to rollback migration

## Database URL

The database URL is automatically loaded from:

1. `config/settings.py` (primary)
2. Environment variable `DATABASE_URL` (fallback)

## Modular Architecture

Migrations are integrated with the modular database architecture:

- **models/database.py**: SQLAlchemy ORM models
- **models/schemas.py**: Pydantic validation schemas
- **models/db_connection.py**: Database connection management

Changes to `models/database.py` will be automatically detected by autogenerate.

## Best Practices

1. **Always review autogenerated migrations** before applying
2. **Test migrations** on development database first
3. **Backup production database** before running migrations
4. **Use meaningful migration messages** that describe the change
5. **Never edit applied migrations** - create a new one instead
6. **Keep migrations small and focused** - one logical change per migration

## Example: Initial Migration

```bash
# Create initial schema
alembic revision --autogenerate -m "Initial schema: one_hop_detections, transactions, intermediate_addresses"

# Review the generated migration in versions/

# Apply migration
alembic upgrade head
```

## Troubleshooting

### "Can't locate revision identified by 'xxx'"

The migrations are out of sync. Check:
- Database `alembic_version` table
- Files in `versions/` directory

### "Target database is not up to date"

Run `alembic upgrade head` to apply pending migrations.

### SQLAlchemy import errors

Ensure all models are imported in `models/database.py` and that `Base.metadata` contains all tables.
